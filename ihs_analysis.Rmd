---
title: "ihs"
author: "Murray Cadzow"
date: "18/03/2015"
output: html_document
---

```{r, fig.height=9, fig.width=12}
library(dplyr)
library(ggplot2)
library(scales)
library(rehh)
library(qqman)
library(knitr)
library(readr)
opts_knit$set(root.dir="/run/user//1001//gvfs/smb-share:server=biocldap,share=scratch/merrimanlab/murray/working_dir/extract/ihh_ihs/")
POP=""
ihs=data.frame()
s=data.frame()
make_graph=function(ihs,s){
  ggplot(data = ihs, aes(x=POSITION, y=iHS), ylim=c(min(ihs$iHS -0.5), max(ihs$iHS + 0.5)))  + geom_point(shape = 16, colour= alpha("black", 1/5)) + facet_wrap(~CHR, scales = "free_x")  + geom_hline(aes(yintercept= q1, colour ="quantile"), data=s,)  + geom_hline(aes(yintercept= q2, colour ="quantile"), data=s)  +geom_hline(aes(yintercept= m, colour="mean"), data=s) + scale_colour_manual("",breaks=c("mean","quantile"),values=c("blue","red")) + scale_x_continuous( xlab("Chromosome Position (Mbp)")) + ylab("iHS") + ggtitle(paste0(POP," iHS by Chromosome")) + theme( plot.background= element_rect(colour="black",fill=NA), legend.position= c(0.75, 0.12)) + theme_bw()
  }
#setwd("/run/user//1001/gvfs/smb-share:server=biocldap,share=scratch/merrimanlab/murray/working_dir/extract/ihh_ihs/")


#for( POP in c("AXIOM","OMNI","CEU","CHB","CHS","GBR","YRI")){
#  print(POP)
ihs_stats=function(POP){  
  ihh=data.frame()
  for( i in 1:22){
    if(file.exists(file = paste0(POP,"chr",i,".ihh"))){
      ihh=rbind(ihh,read.table(file = paste0(POP,"chr",i,".ihh"), header=TRUE))
      }
    }
  ihs = ihh2ihs(ihh)
  ihs = ihs$res.ihs
  ihs = ihs[!is.na(ihs$iHS),]
  #print(names(ihs))
  #print(head(ihs))
  manhattan(x = ihs[!is.na(ihs$iHS),], chr = "CHR", bp = "POSITION", p = "Pvalue", main=POP)
  s = ihs %>% group_by(CHR) %>% summarise(m=mean(iHS), sd(iHS), min(iHS), max(iHS), q1 = quantile(iHS, 0.01), q2 = quantile(iHS, 0.99))
  print(as.data.frame(s))
  #plot(make_graph(TD,s))
  return(ihs)
  }

df=data.frame()
for(i in 1:22){
  df=rbind(df,read_delim(file=paste0("/run/user//1001/gvfs/smb-share:server=biocldap,share=scratch/merrimanlab/murray/working_dir/extract/fixed_vcf/snpEff_classic/rs_genes",i,".txt"), delim="\t", col_names=c("chr","start","end","rs_ids","gene")) )
}
```


---

AXIOM

---

```{r axiom, echo=FALSE, cache=TRUE}
axiom<-ihs_stats(POP="AXIOM")
ann = merge(axiom, df, by.x=c("CHR","POSITION"), by.y=c("chr", "end"), all.x = TRUE, sort = FALSE)

#ihs pos == df end pos
ann1 = ann %>% arrange(desc(abs(iHS)))
ann1$rank = as.numeric(rownames(ann1))
ann2=na.omit(ann1)

genes=c("ABCG2", "SLC2A9", "PPARGC1A")
ann1 %>% filter(gene %in% genes) %>% group_by(gene) %>% summarise(min(rank), quantile(rank, 0.25),median(rank), mean(rank),quantile(rank, 0.75), max(rank))
a<- ann2 %>%  group_by(gene) %>% summarise(min_rank=min(rank), firstQu=quantile(rank, 0.25),med=median(rank), me=mean(rank), thirdQu=quantile(rank, 0.75), max_rank=max(rank), len=length(rank), v=var(rank)) %>% arrange(me, v)

ann1 %>% filter(gene %in% genes) %>% group_by(gene) %>% ggplot(. , aes(x=gene, y=rank)) + geom_boxplot() +theme_bw()

rm(axiom)
```

---

OMNI

---

```{r omni, echo=FALSE, cache=TRUE}
omni<-ihs_stats(POP="OMNI")
rm(omni)
```


---

CEU

---

```{r ceu, echo=FALSE, cache=TRUE}
ceu<-ihs_stats(POP="CEU")
rm(ceu)
```

---

CHB

---

```{r chb, echo=FALSE, cache=TRUE}
chb<-ihs_stats(POP="CHB")
rm(chb)
```

---

CHS

---

```{r chs, echo=FALSE, cache=TRUE}
chs<-ihs_stats(POP="CHS")
rm(chs)
```

---

GBR

---

```{r gbr, echo=FALSE, cache=TRUE}
gbr<-ihs_stats(POP="GBR")
rm(gbr)
```

---

YRI

---

```{r yri, echo=FALSE, cache=TRUE}
yri<-ihs_stats(POP="YRI")
rm(yri)
```